{% extends "base.html" %}

{% block content %}
<h2 style="margin-bottom: 20px;">안녕하세요, {{ name }}님!</h2>

<div class="card">
    <h2>이용 내역 등록</h2>

    <div class="form-group">
        <label for="usage_date">이용 날짜</label>
        <input type="date" id="usage_date" name="usage_date" required style="max-width: 200px;">
    </div>

    <!-- 상품 선택 버튼 영역 -->
    <label style="display:block; margin-bottom:10px; font-weight:bold;">상품 선택 (클릭하여 담기)</label>
    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
        <div onclick="addToCart('9홀', 2000)" class="product-btn" role="button" tabindex="0">
            <span style="font-size: 1.2rem; display:block; margin-bottom: 5px;">9홀</span>
            <span style="font-weight: bold; color: #2c3e50;">2,000원</span>
        </div>

        <div onclick="addToCart('18홀', 4000)" class="product-btn" role="button" tabindex="0">
            <span style="font-size: 1.2rem; display:block; margin-bottom: 5px;">18홀</span>
            <span style="font-weight: bold; color: #2c3e50;">4,000원</span>
        </div>
    </div>

    <!-- 장바구니 영역 -->
    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef;">
        <h3 style="margin-top: 0; margin-bottom: 15px;">담긴 상품 목록</h3>
        <table style="width: 100%; border-collapse: collapse; background: white; margin-bottom: 10px;">
            <thead>
                <tr style="border-bottom: 2px solid #ddd; background: #eef2f5;">
                    <th style="padding: 10px; text-align: left;">상품명</th>
                    <th style="padding: 10px; text-align: center; width: 140px;">수량</th>
                    <th style="padding: 10px; text-align: right; width: 120px;">소계</th>
                    <th style="padding: 10px; text-align: center; width: 80px;">관리</th>
                </tr>
            </thead>
            <tbody id="cart-tbody">
                <tr id="empty-cart-msg">
                    <td colspan="4" style="text-align: center; padding: 20px; color: #999;">상품을 선택해주세요.</td>
                </tr>
            </tbody>
            <tfoot>
                <tr style="border-top: 2px solid #333;">
                    <td colspan="2" style="text-align: right; padding: 15px; font-weight: bold;">총 금액</td>
                    <td colspan="2"
                        style="text-align: right; padding: 15px; font-weight: bold; font-size: 1.2rem; color: #e74c3c;">
                        <span id="total-amount">0</span>원
                    </td>
                </tr>
            </tfoot>
        </table>

        <button onclick="openConfirmModal()" style="width: 100%; margin-top: 10px;">등록하기</button>
    </div>
</div>

<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0; font-size: 1.25rem; white-space: nowrap;">최근 이용 내역 (최신 10건)</h2>
        <button onclick="openHistoryModal()"
            style="width: auto; background:#3498db; color:white; border:none; border-radius:4px; padding:6px 12px; font-size: 0.9rem; cursor:pointer;">전체
            내역 보기</button>
    </div>
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>이용날짜</th>
                    <th>상품</th>
                    <th>수량</th>
                    <th>금액</th>
                    <th style="text-align:center; width:80px;">관리</th>
                </tr>
            </thead>
            <tbody>
                {% if records %}
                {% for r in records %}
                <tr>
                    <td>{{ r.usage_date }}</td>
                    <td>{{ r.item_name }}</td>
                    <td>{{ r.quantity }}게임</td>
                    <td>{{ "{:,}".format(r.amount) }}원</td>
                    <td style="text-align:center;">
                        <button onclick="deleteRecord({{ r.id }})"
                            style="background:#ff7675; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:0.8rem;">삭제</button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">이용 내역이 없습니다.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 전체 내역 모달 -->
<div id="historyModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 800px; width: 95%;">
        <div class="modal-header">
            <h3>전체 이용 내역</h3>
            <span class="close-btn" onclick="closeHistoryModal()">&times;</span>
        </div>
        <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background:#f1f1f1; border-bottom:2px solid #ddd;">
                        <th style="padding:10px; text-align:left;">이용날짜</th>
                        <th style="padding:10px; text-align:left;">상품</th>
                        <th style="padding:10px; text-align:center;">수량</th>
                        <th style="padding:10px; text-align:right;">금액</th>
                        <th style="padding:10px; text-align:center;">관리</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                    <!-- JS로 로드 -->
                </tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeHistoryModal()">닫기</button>
        </div>
    </div>
</div>

<style>
    /* 상품 버튼 스타일 (기존 심플 스타일) */
    .product-btn {
        flex: 1;
        cursor: pointer;
        border: 2px solid #ddd;
        border-radius: 12px;
        /* 둥글게 */
        padding: 24px 15px;
        /* 터치 영역 확대 */
        text-align: center;
        background: white;
        transition: all 0.2s;
        user-select: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        /* 살짝 띄우기 */
    }

    .product-btn:hover {
        border-color: #3498db;
        background-color: #f0f8ff;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .product-btn:active {
        transform: translateY(0);
        background-color: #e1f0fa;
    }

    /* 수량 조절 UI 스타일 */
    .qty-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0;
    }

    .qty-btn {
        width: 40px;
        /* 더 크게 */
        height: 40px;
        /* 더 크게 */
        border: 1px solid #ced4da;
        background-color: #f8f9fa;
        color: #495057;
        font-weight: bold;
        font-size: 1.2rem;
        /* 글자도 크게 */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: background-color 0.15s;
    }

    .qty-btn:first-child {
        border-right: none;
        border-radius: 6px 0 0 6px;
    }

    .qty-btn:last-child {
        border-left: none;
        border-radius: 0 6px 6px 0;
    }

    .qty-btn:hover {
        background-color: #e2e6ea;
    }

    .qty-input {
        width: 50px;
        /* 더 넓게 */
        height: 40px;
        /* 높이 맞춤 */
        border: 1px solid #ced4da;
        text-align: center;
        font-size: 1.1rem;
        /* 글자 크게 */
        font-weight: bold;
        border-radius: 0;
        margin: 0;
        -moz-appearance: textfield;
        appearance: textfield;
    }

    .qty-input::-webkit-outer-spin-button,
    .qty-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* 삭제 버튼 스타일 */
    .btn-delete {
        background-color: #ffeaea;
        color: #e74c3c;
        border: 1px solid #ffcccc;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: background 0.2s;
        min-width: 60px;
    }

    .btn-delete:hover {
        background-color: #ffdddd;
    }

    /* 기존 스타일 호환용 */
    .card {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        /* 더 부드럽게 */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        /* 그림자 부드럽게 */
        margin-bottom: 2rem;
    }

    /* 모달 스타일 (심플하게 유지) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        /* 모바일 여백 */
    }

    .modal-content {
        background: white;
        width: 100%;
        max-width: 450px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        /* 화면 꽉 차지 않게 */
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: bold;
    }

    .close-btn {
        cursor: pointer;
        font-size: 1.5rem;
        color: #999;
        padding: 5px;
        /* 터치 영역 */
    }

    .modal-body {
        padding: 20px;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        justify-content: stretch;
    }

    .btn-cancel {
        flex: 1;
        background: #f1f3f5;
        color: #495057;
        border: none;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    .btn-confirm {
        flex: 2;
        background: #3498db;
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
    }

    /* Mobile First & Responsive Design */
    @media (max-width: 768px) {

        /* 기본 레이아웃 조정 */
        .card {
            padding: 15px;
            /* 패딩 축소로 공간 확보 */
            margin-bottom: 15px;
            border-radius: 12px;
        }

        h2 {
            font-size: 1.15rem !important;
            /* 제목 크기 적절히 축소 */
            white-space: nowrap;
            /* 한 줄 유지 */
            overflow: hidden;
            text-overflow: ellipsis;
            /* 넘치면 ... 처리 */
            margin-bottom: 15px !important;
            letter-spacing: -0.5px;
            /* 자간 좁혀서 더 많이 들어가게 */
        }

        .form-group label {
            font-size: 0.95rem;
            color: #555;
        }

        input[type="date"] {
            width: 100%;
            padding: 10px;
            /* 입력창 높이 살짝 축소 */
            font-size: 1rem;
        }

        /* 상품 버튼 */
        .product-btn {
            padding: 15px 10px;
            /* 내부 여백 축소 */
        }

        .product-btn span:first-child {
            font-size: 1rem !important;
        }

        .product-btn span:last-child {
            font-size: 0.9rem !important;
        }

        /* 테이블 -> 카드 리스트 스타일 다듬기 */
        table,
        thead,
        tbody,
        th,
        td,
        tr {
            display: block;
        }

        thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        tr {
            margin-bottom: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fff;
            box-shadow: none;
            /* 그림자 제거로 깔끔하게 */
        }

        td {
            border: none;
            border-bottom: 1px solid #fcfcfc;
            position: relative;
            padding: 10px 15px 10px 35%;
            /* 라벨 영역 축소 */
            text-align: right;
            min-height: 35px;
            /* 높이 축소 */
            font-size: 0.95rem;
        }

        td:last-child {
            border-bottom: none;
            justify-content: center;
            /* 관리 버튼 등은 중앙 */
            padding-left: 15px;
            /* 라벨 없음 */
            background: #fcfcfc;
        }

        /* 가상 요소로 라벨(헤더) 표시 */
        /* 순서 중요: 상품명, 수량, 소계(금액), 관리 */

        /* 장바구니 테이블 */
        #cart-tbody td:nth-of-type(1):before {
            content: "상품명";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #666;
            width: 30%;
            text-align: left;
        }

        #cart-tbody td:nth-of-type(2):before {
            content: "수량";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #666;
            width: 30%;
            text-align: left;
        }

        #cart-tbody td:nth-of-type(3):before {
            content: "소계";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #666;
            width: 30%;
            text-align: left;
        }

        /* 수량 조절 버튼 우측 정렬 보정 */
        .qty-control {
            margin-left: auto;
        }

        /* 이용 내역 테이블 */
        .table-responsive tbody td:nth-of-type(1):before {
            content: "이용날짜";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #666;
        }

        .table-responsive tbody td:nth-of-type(2):before {
            content: "상품";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #666;
        }

        .table-responsive tbody td:nth-of-type(3):before {
            content: "수량";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #666;
        }

        .table-responsive tbody td:nth-of-type(4):before {
            content: "금액";
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            color: #666;
        }

        /* 빈 내역 메시지 처리 */
        #empty-cart-msg td,
        .table-responsive tr td[colspan] {
            text-align: center;
            padding: 30px;
            display: block;
            width: 100%;
        }

        #empty-cart-msg td:before,
        .table-responsive tr td[colspan]:before {
            content: none !important;
        }

        /* 총 금액 영역 (tfoot) */
        tfoot tr {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
        }

        tfoot td {
            display: inline-block;
            border: none;
            padding: 0;
            width: auto;
            text-align: right;
        }

        tfoot td:first-child {
            text-align: left;
        }

        /* 등록하기 버튼 */
        button[onclick="openConfirmModal()"] {
            padding: 18px;
            font-size: 1.1rem;
            border-radius: 12px;
            background-color: #2ecc71;
            /* 더 산뜻한 초록색 */
            color: white;
            border: none;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(46, 204, 113, 0.3);
        }

        /* 모달 전체 내역 테이블도 동일하게 카드화 */
        #history-tbody td:nth-of-type(1):before {
            content: "이용날짜";
            position: absolute;
            left: 15px;
            font-weight: bold;
            color: #666;
        }

        #history-tbody td:nth-of-type(2):before {
            content: "상품";
            position: absolute;
            left: 15px;
            font-weight: bold;
            color: #666;
        }

        #history-tbody td:nth-of-type(3):before {
            content: "수량";
            position: absolute;
            left: 15px;
            font-weight: bold;
            color: #666;
        }

        #history-tbody td:nth-of-type(4):before {
            content: "금액";
            position: absolute;
            left: 15px;
            font-weight: bold;
            color: #666;
        }

        /* 텍스트 줄바꿈 방지 및 말줄임 (필요시) */
        .card h2 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    }
</style>

<!-- 등록 확인 모달 (스크립트보다 먼저 선언되어야 함) -->
<div id="confirmModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>등록 확인</h3>
            <span class="close-btn" onclick="closeConfirmModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:10px;">다음 내역으로 등록하시겠습니까?</p>
            <div id="modal-cart-summary"
                style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;"></div>
            <div style="text-align:right; font-size:1.2rem; font-weight:bold; color:#e74c3c;">
                총 <span id="modal-total-amount">0</span>원
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeConfirmModal()">취소</button>
            <button class="btn-confirm" onclick="finalSubmit()">확인 및 등록</button>
        </div>
    </div>
</div>

<script>
    // 오늘 날짜 자동 설정
    document.getElementById('usage_date').valueAsDate = new Date();

    let cart = [];

    function addToCart(name, price) {
        const existingItem = cart.find(item => item.name === name);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            cart.push({ name: name, price: price, quantity: 1 });
        }
        renderCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        renderCart();
    }

    function updateQty(index, delta) {
        const item = cart[index];
        item.quantity += delta;
        if (item.quantity <= 0) {
            cart.splice(index, 1);
        }
        renderCart();
    }

    function renderCart() {
        const tbody = document.getElementById('cart-tbody');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const totalSpan = document.getElementById('total-amount');

        tbody.innerHTML = '';

        if (cart.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align: center; padding: 20px; color: #999;">상품을 선택해주세요.</td>';
            tbody.appendChild(tr);
            totalSpan.textContent = '0';
            return;
        }

        let total = 0;

        cart.forEach((item, index) => {
            const tr = document.createElement('tr');
            const subtotal = item.price * item.quantity;
            total += subtotal;

            tr.innerHTML = `
                <td style="padding: 10px;">${item.name}</td>
                <td style="padding: 10px;">
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
                        <input type="number" class="qty-input" value="${item.quantity}" readonly>
                        <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                    </div>
                </td>
                <td style="padding: 10px; text-align: right;">${subtotal.toLocaleString()}원</td>
                <td style="padding: 10px; text-align: center;">
                    <button class="btn-delete" onclick="removeFromCart(${index})">삭제</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        totalSpan.textContent = total.toLocaleString();
    }

    function deleteRecord(id) {
        if (!confirm('해당 이용 내역을 정말 삭제하시겠습니까?')) return;

        // API 요청 (DELETE)
        fetch(`/api/record/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('삭제 실패: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류가 발생했습니다.');
            });
    }

    // 모달 로직
    const modal = document.getElementById('confirmModal');
    const modalBody = document.getElementById('modal-cart-summary');
    const modalTotal = document.getElementById('modal-total-amount');

    function openConfirmModal() {
        if (cart.length === 0) {
            alert('상품을 담아주세요.');
            return;
        }

        const usage_date = document.getElementById('usage_date').value;
        if (!usage_date) {
            alert('날짜를 선택해주세요.');
            return;
        }

        let html = '<ul style="list-style:none; padding:0; margin:0;">';
        let total = 0;
        cart.forEach(item => {
            let sub = item.price * item.quantity;
            total += sub;
            html += `<li style="padding: 8px 0; border-bottom: 1px solid #eee; display:flex; justify-content:space-between;">
                        <span>${item.name} x ${item.quantity}</span>
                        <span style="font-weight:bold;">${sub.toLocaleString()}원</span>
                     </li>`;
        });
        html += '</ul>';
        html = `<div style="margin-bottom:15px; color:#666; font-size:0.9rem;">이용 날짜: <strong>${usage_date}</strong></div>` + html;

        modalBody.innerHTML = html;
        modalTotal.textContent = total.toLocaleString();
        modal.style.display = 'flex';
    }

    function closeConfirmModal() {
        modal.style.display = 'none';
    }

    function finalSubmit() {
        const usage_date = document.getElementById('usage_date').value;
        const payload = {
            usage_date: usage_date,
            cart: cart.map(item => ({
                item_name: item.name,
                quantity: item.quantity,
                price: item.price
            }))
        };

        fetch("{{ url_for('add_record') }}", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert('오류: ' + data.message);
                    closeConfirmModal();
                }
            })
            .catch(err => {
                console.error(err);
                alert('서버 통신 중 오류가 발생했습니다.');
                closeConfirmModal();
            });
    }

    // --- 전체 내역 모달 로직 ---
    const historyModal = document.getElementById('historyModal');

    function openHistoryModal() {
        historyModal.style.display = 'flex';
        loadHistoryData();
    }

    function closeHistoryModal() {
        historyModal.style.display = 'none';
    }

    function loadHistoryData() {
        const tbody = document.getElementById('history-tbody');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">로딩 중...</td></tr>';

        fetch('/api/history')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    renderHistoryTable(data.data);
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:red;">${data.message}</td></tr>`;
                }
            })
            .catch(err => {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:red;">오류 발생</td></tr>';
            });
    }

    function renderHistoryTable(records) {
        const tbody = document.getElementById('history-tbody');
        tbody.innerHTML = '';

        if (records.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">이용 내역이 없습니다.</td></tr>';
            return;
        }

        records.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="padding:10px; border-bottom:1px solid #eee;">${r.usage_date}</td>
                <td style="padding:10px; border-bottom:1px solid #eee;">${r.item_name}</td>
                <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">${r.quantity}게임</td>
                <td style="padding:10px; border-bottom:1px solid #eee; text-align:right;">${r.amount.toLocaleString()}원</td>
                <td style="padding:10px; border-bottom:1px solid #eee; text-align:center;">
                    <button onclick="deleteRecord(${r.id})" style="background:#ff7675; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:0.8rem;">삭제</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 모달 닫기 이벤트 통합
    window.onclick = function (event) {
        if (event.target == modal) {
            closeConfirmModal();
        }
        if (event.target == historyModal) {
            closeHistoryModal();
        }
    }
</script>

{% endblock %}